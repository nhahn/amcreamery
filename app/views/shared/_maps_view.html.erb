<script type="text/javascript">
    var directionsService = new google.maps.DirectionsService();
    var directionDisplay;
    var markerArray = [];
    var map;
    var stepDisplay
  $("#map_canvas").ready(function() {
    directionsDisplay = new google.maps.DirectionsRenderer();
    
    var position = new google.maps.LatLng(40.4406, 79.9961);
    var myOptions = {
          zoom: 13,
          center: position,
          mapTypeId: google.maps.MapTypeId.ROADMAP,
          mapTypeControl: true,
          mapTypeControlOptions: {style: google.maps.MapTypeControlStyle.DROPDOWN_MENU},
          navigationControl: true,
          navigationControlOptions: {style: google.maps.NavigationControlStyle.SMALL}, 
        };
        map = new google.maps.Map(
            document.getElementById("map_canvas"),
            myOptions);
        directionsDisplay.setMap(map);
        var contentString;
        var infowindow;
        var tempLatLng;
        var latlngbounds = new google.maps.LatLngBounds();
        <% stores.each do |store| %> 
    
          tempLatLng = new google.maps.LatLng(<%="#{store.latitude}, #{store.longitude}"%>);
          var marker = new google.maps.Marker({
              position: tempLatLng,
              map: map,
              title:"<%=store.name%>"
          });
          latlngbounds.extend(tempLatLng);
          var contentString = '<%=store.name%>' +
          '<p>Find direction from:</p>'+
          '<form action="<%=request.url%>" onsubmit="calcRoute(\'<%="#{store.latitude}, #{store.longitude}"%>\');return false;">'+
          '<input type="text" id="start">'+
          '<input class="btn btn-primary" type="submit" value="Get directions"></form>';
          attachInstructionText(marker,contentString);  
        <% end %>
        map.setCenter(latlngbounds.getCenter());
        map.fitBounds(latlngbounds);
        stepDisplay = new google.maps.InfoWindow(); 
  });

      function calcRoute(position) {

      // First, clear out any existing markerArray
      // from previous calculations.
      for (i = 0; i < markerArray.length; i++) {
        markerArray[i].setMap(null);
      }

      // Retrieve the start and end locations and create
      // a DirectionsRequest using WALKING directions.
      var start = document.getElementById("start").value;
      var end = position; 
      var request = {
          origin: start,
          destination: end,
          travelMode: google.maps.TravelMode.DRIVING
      };

      // Route the directions and pass the response to a
      // function to create markers for each step.
      directionsService.route(request, function(response, status) {
        if (status == google.maps.DirectionsStatus.OK) {
          var warnings = document.getElementById("warnings_panel");
          warnings.innerHTML = "" + response.routes[0].warnings + "";
          directionsDisplay.setDirections(response);
          showSteps(response);
        }
      });
    }

    function showSteps(directionResult) {
      // For each step, place a marker, and add the text to the marker's
      // info window. Also attach the marker to an array so we
      // can keep track of it and remove it when calculating new
      // routes.
      var myRoute = directionResult.routes[0].legs[0];

      for (var i = 0; i < myRoute.steps.length; i++) {
          var marker = new google.maps.Marker({
            position: myRoute.steps[i].start_point,
            map: map
          });
          attachInstructionText(marker, myRoute.steps[i].instructions);
          markerArray[i] = marker;
      }
    }

    function attachInstructionText(marker, text) {
      google.maps.event.addListener(marker, 'click', function() {
        stepDisplay.setContent(text);
        stepDisplay.open(map, marker);
      });
    }
</script>
